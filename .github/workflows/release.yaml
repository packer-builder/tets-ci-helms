name: Release Charts

on:
  push:
    branches:
      - main
    paths:
      - 'charts/**'

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      charts: ${{ steps.changed-charts.outputs.charts }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed charts
        id: changed-charts
        run: |
          # Get list of changed charts
          CHANGED_DIRS=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} -- 'charts/' | cut -d'/' -f2 | sort -u | grep -v '^$' || true)

          if [[ -z "$CHANGED_DIRS" ]]; then
            echo "charts=[]" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Build JSON array
          JSON_ARRAY="["
          FIRST=true
          for dir in $CHANGED_DIRS; do
            if [[ -f "charts/$dir/Chart.yaml" ]]; then
              if [[ "$FIRST" == "true" ]]; then
                JSON_ARRAY="$JSON_ARRAY\"$dir\""
                FIRST=false
              else
                JSON_ARRAY="$JSON_ARRAY,\"$dir\""
              fi
            fi
          done
          JSON_ARRAY="$JSON_ARRAY]"

          echo "charts=$JSON_ARRAY" >> "$GITHUB_OUTPUT"
          echo "Changed charts: $JSON_ARRAY"

  bump-and-release:
    needs: detect-changes
    if: needs.detect-changes.outputs.charts != '[]'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
    strategy:
      matrix:
        chart: ${{ fromJson(needs.detect-changes.outputs.charts) }}
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Detect bump type from commits
        id: bump-type
        run: |
          chmod +x scripts/detect-bump-type.sh
          BUMP_TYPE=$(./scripts/detect-bump-type.sh "${{ matrix.chart }}")
          echo "type=$BUMP_TYPE" >> "$GITHUB_OUTPUT"
          echo "Bump type for ${{ matrix.chart }}: $BUMP_TYPE"

      - name: Bump chart version
        id: bump-version
        run: |
          chmod +x scripts/bump-chart-version.sh
          NEW_VERSION=$(./scripts/bump-chart-version.sh "charts/${{ matrix.chart }}" "${{ steps.bump-type.outputs.type }}")
          echo "new_version=$NEW_VERSION" >> "$GITHUB_OUTPUT"
          echo "New version for ${{ matrix.chart }}: $NEW_VERSION"

      - name: Commit version bump
        run: |
          git add charts/${{ matrix.chart }}/Chart.yaml
          git commit -m "chore(${{ matrix.chart }}): bump version to ${{ steps.bump-version.outputs.new_version }} [skip ci]" || echo "No changes to commit"
          git pull --rebase origin main || true
          git push

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Run chart-releaser
        uses: helm/chart-releaser-action@v1.6.0
        with:
          charts_dir: charts
          skip_existing: true
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"

  update-index:
    needs: bump-and-release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Update Helm repo index
        run: |
          helm repo index . --url https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}
          git add index.yaml
          git commit -m "chore: update helm repo index [skip ci]" || echo "No changes to commit"
          git pull --rebase origin gh-pages || true
          git push
