name: Release Please

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write
  pages: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      releases_created: ${{ steps.release.outputs.releases_created }}
      paths_released: ${{ steps.release.outputs.paths_released }}
    steps:
      - name: Release Please
        id: release
        uses: googleapis/release-please-action@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

  release-charts:
    needs: release-please
    if: needs.release-please.outputs.releases_created == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Package and upload charts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get released paths from release-please
          PATHS='${{ needs.release-please.outputs.paths_released }}'
          echo "Released paths: $PATHS"

          # Package each released chart and upload to its release
          for path in $(echo "$PATHS" | jq -r '.[]'); do
            chart_name=$(basename "$path")
            echo "Processing chart: $chart_name in $path"

            # Get version from Chart.yaml
            version=$(grep '^version:' "$path/Chart.yaml" | awk '{print $2}')
            echo "Chart version: $version"

            # Package the chart
            helm package "$path" -d .cr-release-packages/

            # Upload to the release
            tag="${chart_name}-${version}"
            pkg_file=".cr-release-packages/${chart_name}-${version}.tgz"

            if [[ -f "$pkg_file" ]]; then
              echo "Uploading $pkg_file to release $tag"
              gh release upload "$tag" "$pkg_file" --clobber || echo "Failed to upload to $tag"
            fi
          done

  update-index:
    needs: release-charts
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Update Helm repo index and README
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Download all chart packages from releases
          mkdir -p .chart-packages

          for release in $(gh release list --limit 50 --json tagName --jq '.[].tagName' | grep -E '^[a-z]+-[a-z]+-[0-9]+\.[0-9]+\.[0-9]+$'); do
            echo "Checking release: $release"
            gh release download "$release" -D .chart-packages --pattern "*.tgz" 2>/dev/null || true
          done

          # Generate index from downloaded packages
          if ls .chart-packages/*.tgz 1>/dev/null 2>&1; then
            helm repo index .chart-packages --url https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}
            mv .chart-packages/index.yaml ./index.yaml

            # Generate README with available charts and versions
            cat > README.md << 'EOF'
          # Helm Charts Repository

          This repository hosts Helm charts for Kubernetes deployments.

          ## Usage

          ### Add the repository

          ```bash
          helm repo add tets-ci-helms https://packer-builder.github.io/tets-ci-helms
          helm repo update
          ```

          ### Search available charts

          ```bash
          helm search repo tets-ci-helms
          ```

          ### Install a chart

          ```bash
          helm install my-release tets-ci-helms/<chart-name>
          ```

          ## Available Charts

          EOF

            # Parse index.yaml and generate chart sections with versions
            python3 << 'PYSCRIPT' >> README.md
          import yaml

          with open('index.yaml', 'r') as f:
              index = yaml.safe_load(f)

          entries = index.get('entries', {})

          for chart_name in sorted(entries.keys()):
              versions = entries[chart_name]
              if versions:
                  latest = versions[0]
                  description = latest.get('description', 'No description')
                  all_versions = [v.get('version', '') for v in versions]

                  print(f"### {chart_name}")
                  print(f"")
                  print(f"{description}")
                  print(f"")
                  print(f"**Latest version:** `{latest.get('version', 'N/A')}`")
                  print(f"")
                  print(f"**Available versions:** {', '.join([f'`{v}`' for v in all_versions])}")
                  print(f"")
                  print(f"```bash")
                  print(f"helm install my-{chart_name} tets-ci-helms/{chart_name}")
                  print(f"```")
                  print(f"")
          PYSCRIPT

            cat >> README.md << 'EOF'
          ## Links

          - [Source Repository](https://github.com/packer-builder/tets-ci-helms)
          - [Helm Documentation](https://helm.sh/docs/)
          EOF

            git add index.yaml README.md
            git commit -m "chore: update helm repo index and README [skip ci]" || echo "No changes to commit"
            git pull --rebase origin gh-pages || true
            git push
          else
            echo "No chart packages found"
          fi
